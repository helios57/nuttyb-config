(()=>{"use strict";const e={maps:[{name:"Full Metal Plate (12P)",commands:["!map Full Metal Plate","!addbox 82 82 117 117 2","!clearbox 1"]},{name:"Raptor Crater (16P)",commands:["!map Raptor Crater","!addbox 84 81 119 116 2","!clearbox 1","!teamsize 16"]},{name:"Raptor Crater Inverted (16P)",commands:["!map Raptor Crater","!disablemapdamage 0","!debugcommands invertmap","!addbox 84 81 119 116 2","!clearbox 1","!teamsize 16"]},{name:"Special Hotstepper (16P)",commands:["!map Special Hotstepper","!addbox 83 81 118 116 2","!clearbox 1","!map_lavatiderhythm disabled","!teamsize 16"]},{name:"To Kill The Middle (12P)",commands:["!map To Kill The Middle","!addbox 82 82 117 117 2","!clearbox 1","!teamsize 12"]},{name:"Ancient Bastion Remake (8P)",commands:["!map Ancient Bastion Remake","!addbox 0 0 100 200 1","!addbox 175 0 200 200 2","!teamsize 8"]},{name:"Ancient Vault (12P)",commands:["!map Ancient Vault","!addbox 0 0 200 120 1","!addbox 0 180 200 200 2","!teamsize 12"]},{name:"Bismuth Valley (8P)",commands:["!map Bismuth Valley","!addbox 0 0 64 200 1","!addbox 175 0 200 200 2","!teamsize 8"]},{name:"Darkside (12P)",commands:["!map Darkside","!addbox 0 0 64 200 1","!addbox 175 0 200 200 2","!teamsize 12"]},{name:"Flats and Forests (12P)",commands:["!map Flats and Forests","!addbox 0 0 64 200 1","!addbox 175 0 200 200 2","!teamsize 12"]},{name:"Special Creek (12P)",commands:["!map Special Creek","!addbox 158 0 200 200 2","!teamsize 12"]},{name:"Starwatcher (8P)",commands:["!map Starwatcher","!addbox 0 0 64 200 1","!addbox 175 0 200 200 2","!teamsize 8"]}],modes:[{name:"No Rush",commands:["!raptor_queentimemult 1.3","!raptor_spawncountmult 3","!raptor_firstwavesboost 6","!raptor_graceperiodmult 3"]},{name:"No Rush Solo",commands:["!raptor_queentimemult 1.3","!raptor_spawncountmult 3","!raptor_firstwavesboost 3","!raptor_graceperiodmult 2.7"]},{name:"Zero Grace",commands:["!raptor_queentimemult 1.4","!raptor_spawncountmult 3","!raptor_firstwavesboost 3","!raptor_graceperiodmult 0.1"]},{name:"Surrounded",commands:["!raptor_queentimemult 1.3","!raptor_spawncountmult 3","!raptor_firstwavesboost 6","!raptor_graceperiodmult 3","!addbox 60 60 140 140 1","!raptor_raptorstart avoid","!clearbox 2"]}],base:["!preset coop","!teamsize 12","!autobalance off","!assistdronesbuildpowermultiplier 1","!assistdronesenabled enabled","!commanderbuildersbuildpower 1000","!commanderbuildersenabled enabled","!commanderbuildersrange 1000","!disablemapdamage 1","!experimentalextraunits 1","!experimentallegionfaction 1","!experimentalshields bounceeverything","!maxunits 10000","!multiplier_builddistance 2","!multiplier_buildpower 2","!multiplier_buildtimecost 1","!multiplier_energyconversion 1","!multiplier_energycost 1","!multiplier_energyproduction 1","!multiplier_losrange 1","!multiplier_maxdamage 1","!multiplier_maxvelocity 1","!multiplier_metalcost 1","!multiplier_metalextraction 1","!multiplier_radarrange 1","!multiplier_resourceincome 2","!multiplier_shieldpower 2","!multiplier_turnrate 1","!multiplier_weapondamage 1","!multiplier_weaponrange 1","!raptor_difficulty epic","!raptor_spawntimemult 1","!releasecandidates 1","!startenergy 10000","!startenergystorage 10000","!startmetal 10000","!startmetalstorage 10000","!scavunitsforplayers 1","!forceallunits 1","!unit_restrictions_noair 0","!unit_restrictions_noendgamelrpc 0","!unit_restrictions_noextractors 1","!unit_restrictions_nolrpc 0","!unit_restrictions_nonukes 0","!draft_mode disabled","!unit_restrictions_notacnukes 0","$welcome-message Settings made with NuttyB Configurator https://rcorex.github.io/nuttyb-config/","!unit_market 0","!evocom 0","!nowasting all","!bSet unit_restrictions_nonukes 1","!bSet raptor_queen_count 8","!balance"],scavengers:["!scav_boss_count 8","!scav_bosstimemult 1.3","!scav_difficulty epic","!scav_spawncountmult 2","!bSet ruins disabled","!shieldsrework 1","!unit_restrictions_noextractors 0"]},t=[{label:"NuttyB Main Tweaks",type:"checkbox",column:"left",default:!0,commandBlocks:[]},{label:"NuttyB Evolving Commanders",type:"checkbox",column:"left",default:!1,commandBlocks:["!evocom 1"]},{label:"Optimization & Scaling",type:"header",column:"left"},{label:"Enable Singularity Fusion",type:"checkbox",column:"left",default:!1,modOption:"fusion_mode",commandBlocks:[]},{label:"Fusion - Min Tier",type:"numeric-tweak",column:"left",defaultValue:"1",min:1,step:1,modOption:"fusion_mintier"},{label:"Fusion Efficiency Bonus",type:"numeric-tweak",column:"left",defaultValue:"1.10",min:1,step:.05,modOption:"fusion_efficiency"},{label:"Enable Adaptive Spawner",type:"checkbox",column:"left",default:!1,modOption:"adaptive_spawner",commandBlocks:[]},{label:"Max Compression Factor",type:"numeric-tweak",column:"left",defaultValue:"10",min:1,max:10,step:1,modOption:"adaptive_compression_max"},{label:"Enable Vampire Merge",type:"checkbox",column:"left",default:!1,modOption:"adaptive_vampire",commandBlocks:[]},{label:"Enable Boss Tint",type:"checkbox",column:"left",default:!1,modOption:"adaptive_boss_tint",commandBlocks:[]},{label:"Enable Auto-Culling",type:"checkbox",column:"left",default:!1,modOption:"cull_enabled",commandBlocks:[]},{label:"Culling - Min SimSpeed",type:"numeric-tweak",column:"left",defaultValue:"0.9",min:.1,step:.1,modOption:"cull_simspeed"},{label:"Culling - Max Units",type:"numeric-tweak",column:"left",defaultValue:"5000",min:100,step:100,modOption:"cull_maxunits"},{label:"Safe Zone Radius",type:"numeric-tweak",column:"left",defaultValue:"2000",min:500,step:100,modOption:"cull_radius"},{label:"Mechanics & Balance",type:"checkbox",column:"left",default:!0,commandBlocks:[]},{label:"Cross Faction T2",type:"checkbox",column:"left",default:!1,commandBlocks:[]},{label:"T3 Eco",type:"checkbox",column:"left",default:!1,commandBlocks:[]},{label:"T3 Builders",type:"checkbox",column:"left",default:!1,commandBlocks:[]},{label:"Unit Launchers",type:"checkbox",column:"left",default:!1,commandBlocks:[],tweakTemplateId:"tweak_enable_unit_launchers"},{label:"LRPC Rebalance v2",type:"checkbox",column:"left",default:!1,commandBlocks:[]},{label:"T4 Defences Test",type:"checkbox",column:"left",default:!1,commandBlocks:[]},{label:"T4 Air Rework",type:"checkbox",column:"left",default:!1,commandBlocks:[]},{label:"Mega Nuke",type:"checkbox",column:"left",default:!1,commandBlocks:[]},{label:"Raptor Health",type:"select",isHpGenerator:!0,hpType:"hp",column:"left",slot:"",slotType:"tweakdefs",defaultValue:"1.3",choices:[{label:"Default",value:"",shortLabel:""},{label:"1x HP",value:"1",shortLabel:"1x HP"},{label:"1.3x HP",value:"1.3",shortLabel:"1_3x HP"},{label:"1.5x HP",value:"1.5",shortLabel:"1_5x HP"},{label:"1.7x HP",value:"1.7",shortLabel:"1_7x HP"},{label:"2x HP",value:"2",shortLabel:"2x HP"},{label:"2.5x HP",value:"2.5",shortLabel:"2_5x HP"},{label:"3x HP",value:"3",shortLabel:"3x HP"},{label:"4x HP",value:"4",shortLabel:"4x HP"},{label:"5x HP",value:"5",shortLabel:"5x HP"}]},{label:"Queen Health",type:"select",isHpGenerator:!0,hpType:"qhp",column:"left",slot:1,slotType:"tweakdefs",defaultValue:"1.3",choices:[{label:"Default",value:"",shortLabel:""},{label:"1x QHP",value:"1",shortLabel:"1x QHP"},{label:"1.3x QHP",value:"1.3",shortLabel:"1_3x QHP"},{label:"1.5x QHP",value:"1.5",shortLabel:"1_5x QHP"},{label:"1.7x QHP",value:"1.7",shortLabel:"1_7x QHP"},{label:"2x QHP",value:"2",shortLabel:"2x QHP"},{label:"2.5x QHP",value:"2.5",shortLabel:"2_5x QHP"},{label:"3x QHP",value:"3",shortLabel:"3x QHP"},{label:"4x QHP",value:"4",shortLabel:"4x QHP"},{label:"5x QHP",value:"5",shortLabel:"5x QHP"}]},{label:"Limit Max Allowed",type:"header",column:"left"},{label:"T3 Builders",type:"numeric-tweak",column:"left",defaultValue:"10",min:0,unitLabel:"max/unit",tweakTemplateId:"tweak_limit_t3builders",tweakVar:"limit"},{label:"Unit Launchers",type:"numeric-tweak",column:"left",defaultValue:"20",min:0,unitLabel:"max/unit",tweakTemplateId:"tweak_limit_unit_launchers",tweakVar:"limit"},{label:"Epic Ragnarok",type:"numeric-tweak",column:"left",defaultValue:"80",min:0,unitLabel:"max/unit",tweakTemplateId:"tweak_limit_epic_ragnarok",tweakVar:"limit"},{label:"Epic Calamity",type:"numeric-tweak",column:"left",defaultValue:"80",min:0,unitLabel:"max/unit",tweakTemplateId:"tweak_limit_epic_calamity",tweakVar:"limit"},{label:"Epic Tyrannus",type:"numeric-tweak",column:"left",defaultValue:"80",min:0,unitLabel:"max/unit",tweakTemplateId:"tweak_limit_epic_tyrannus",tweakVar:"limit"},{label:"Epic Starfall",type:"numeric-tweak",column:"left",defaultValue:"80",min:0,unitLabel:"max/unit",tweakTemplateId:"tweak_limit_epic_starfall",tweakVar:"limit"},{label:"Game Multipliers",type:"header",column:"left"},{label:"Resource Income",type:"numeric-tweak",column:"left",defaultValue:"2",min:0,step:.1,modOption:"multiplier_resourceincome"},{label:"Shield Power",type:"numeric-tweak",column:"left",defaultValue:"2",min:0,step:.1,modOption:"multiplier_shieldpower"},{label:"Build Range",type:"numeric-tweak",column:"left",defaultValue:"2",min:0,step:.1,modOption:"multiplier_builddistance"},{label:"Build Power",type:"numeric-tweak",column:"left",defaultValue:"2",min:0,step:.1,modOption:"multiplier_buildpower"},{label:"Raptor Settings",type:"header",column:"left"},{label:"Queen Quantity",type:"numeric-tweak",column:"left",defaultValue:"8",min:0,step:1,modOption:"raptor_queen_count"},{label:"Wave Multiplier",type:"numeric-tweak",column:"left",defaultValue:"1",min:0,step:.1,modOption:"raptor_spawncountmult"},{label:"First Waves Boost",type:"numeric-tweak",column:"left",defaultValue:"0",min:0,step:1,modOption:"raptor_firstwavesboost"},{label:"Grace Period Multiplier",type:"numeric-tweak",column:"left",defaultValue:"1",min:0,step:.1,modOption:"raptor_graceperiodmult"}];var a=function(e,t,a,o){return new(a||(a=Promise))(function(n,l){function s(e){try{r(o.next(e))}catch(e){l(e)}}function i(e){try{r(o.throw(e))}catch(e){l(e)}}function r(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a(function(e){e(t)})).then(s,i)}r((o=o.apply(e,t||[])).next())})};function o(){return a(this,void 0,void 0,function*(){return{rawOptionsData:[],formOptionsConfig:t}})}function n(){return a(this,void 0,void 0,function*(){try{const e=yield fetch(`links.md?t=${Date.now()}`);if(!e.ok)return"";const t=yield e.text();return"undefined"!=typeof marked&&marked.parse?marked.parse(t):t}catch(e){return console.error("Failed to load links content",e),""}})}function l(t){return a(this,void 0,void 0,function*(){return e})}const s="nuttyb-custom-tweaks";let i=[];function r(e){i=e,localStorage.setItem(s,JSON.stringify(i))}function c(){return i}const d=JSON.parse('{"qhp":{"name":"Queen Health & Repair","description":"Queen Health & Repair Adjustments","scope":"UnitDefsLoop","conditions":[{"type":"nameStartsWith","prefix":"raptor_queen_"}],"mutations":[{"op":"set","field":"repairable","value":false},{"op":"set","field":"canbehealed","value":false},{"op":"set","field":"buildTime","value":9999999},{"op":"set","field":"autoHeal","value":2},{"op":"set","field":"canSelfRepair","value":false},{"op":"multiply","field":"health","factor":{"type":"variable","key":"multiplier"}}]},"raptor_swarmer_heal":{"name":"Swarmer Heal Adjustments","description":"Swarmer Heal adjustments","scope":"UnitDefsLoop","conditions":[{"type":"nameMatch","regex":"^raptor_land_swarmer_heal"}],"mutations":[{"op":"set","field":"reclaimSpeed","value":100},{"op":"set","field":"stealth","value":false},{"op":"set","field":"builder","value":false},{"op":"multiply","field":"buildSpeed","factor":{"type":"variable","key":"workertimeMultiplier"}},{"op":"set","field":"canAssist","value":false},{"op":"set","field":"maxThisUnit","value":0}]},"raptor_health":{"name":"Raptor Health Adjustments","description":"Raptor Health adjustments","scope":"UnitDefsLoop","conditions":[{"type":"customParam","key":"subfolder","value":"other/raptors"},{"type":"nameNotMatch","regex":"^raptor_queen_.*"}],"mutations":[{"op":"multiply","field":"health","factor":{"type":"variable","key":"healthMultiplier"}}]},"raptor_metal_chase":{"name":"Raptor Metal & Chase","description":"Metal Cost and NoChase","scope":"UnitDefsLoop","conditions":[{"type":"customParam","key":"subfolder","value":"other/raptors"}],"mutations":[{"op":"set","field":"noChaseCategory","value":"OBJECT"},{"op":"assign_math_floor","target":"metalCost","source":"health","factor":{"type":"variable","key":"metalCostFactor"}}]},"boss_hp":{"name":"Scav Boss HP","description":"Scavenger Boss HP adjustment","scope":"UnitDef_Post","conditions":[{"type":"nameStartsWith","prefix":"scavengerbossv4"}],"mutations":[{"op":"multiply","field":"health","factor":{"type":"variable","key":"multiplier"}}]},"scav_hp_health":{"name":"Scavengers HP - Health","description":"Scavenger Health","scope":"UnitDef_Post","conditions":[{"type":"nameEndsWith","suffix":"_scav"},{"type":"nameNotMatch","regex":"^scavengerbossv4"}],"mutations":[{"op":"assign_math_floor","target":"health","source":"health","factor":{"type":"variable","key":"multiplier"}}]},"scav_hp_metal":{"name":"Scavengers HP - Metal & Category","description":"Scavenger Metal Cost and Category","scope":"UnitDef_Post","conditions":[{"type":"nameEndsWith","suffix":"_scav"}],"mutations":[{"op":"assign_math_floor","target":"metalCost","source":"metalCost","factor":{"type":"variable","key":"multiplier"}},{"op":"set","field":"noChaseCategory","value":"OBJECT"}]},"add_to_build_menu":{"name":"Add Unit to Factory","description":"Adds unit to build options","scope":"UnitDefsLoop","conditions":[{"type":"nameStartsWith","prefix":{"type":"variable","key":"factoryPrefix"}}],"mutations":[{"op":"list_append","field":"buildoptions","value":{"type":"variable","key":"unitName"}}]},"tweak_limit_t3builders":{"name":"Limit T3 Builders","description":"Limits T3 Builders","scope":"UnitDefsLoop","conditions":[{"type":"nameInList","names":["armconst3","corconst3","legconst3"]}],"mutations":[{"op":"set","field":"maxThisUnit","value":{"type":"variable","key":"limit"}}]},"tweak_limit_unit_launchers":{"name":"Limit Unit Launchers","description":"Limits Unit Launchers","scope":"UnitDefsLoop","conditions":[{"type":"nameInList","names":["armmeatball","corclogger"]}],"mutations":[{"op":"set","field":"maxThisUnit","value":{"type":"variable","key":"limit"}}]},"tweak_limit_epic_ragnarok":{"name":"Limit Ragnarok","description":"Limits Epic Ragnarok","scope":"UnitDefsLoop","conditions":[{"type":"nameMatch","regex":"ragnarok"}],"mutations":[{"op":"set","field":"maxThisUnit","value":{"type":"variable","key":"limit"}}]},"tweak_limit_epic_calamity":{"name":"Limit Calamity","description":"Limits Epic Calamity","scope":"UnitDefsLoop","conditions":[{"type":"nameMatch","regex":"calamity"}],"mutations":[{"op":"set","field":"maxThisUnit","value":{"type":"variable","key":"limit"}}]},"tweak_limit_epic_tyrannus":{"name":"Limit Tyrannus","description":"Limits Epic Tyrannus","scope":"UnitDefsLoop","conditions":[{"type":"nameMatch","regex":"tyrannus"}],"mutations":[{"op":"set","field":"maxThisUnit","value":{"type":"variable","key":"limit"}}]},"tweak_limit_epic_starfall":{"name":"Limit Starfall","description":"Limits Epic Starfall","scope":"UnitDefsLoop","conditions":[{"type":"nameMatch","regex":"starfall"}],"mutations":[{"op":"set","field":"maxThisUnit","value":{"type":"variable","key":"limit"}}]},"tweak_enable_unit_launchers":{"name":"Enable Unit Launchers","description":"Adds Unit Launchers to T2 Vehicle Plants","scope":"UnitDefsLoop","conditions":[{"type":"nameInList","names":["armavp","coravp","legavp"]}],"mutations":[{"op":"list_append","field":"buildoptions","value":"armmeatball"},{"op":"list_append","field":"buildoptions","value":"corclogger"}]}}');class m{constructor(){this.builder=[],this.indentLevel=0,this.usedGlobals=new Set}compile(e){this.builder=[],this.indentLevel=0,this.usedGlobals=new Set,this.scanGlobals(e),this.emitGlobals(),this.addStatement("");const t=e.filter(e=>"UnitDefsLoop"===e.tweak.scope),a=e.filter(e=>"UnitDef_Post"===e.tweak.scope),o=e.filter(e=>"Global"===e.tweak.scope);if(o.length>0)for(const e of o)for(const t of e.tweak.mutations)this.generateMutation(t,"nil",e.variables);if(t.length>0){this.startLoop("for id, def in pairs(UnitDefs)"),this.addLocal("name","def.name or id");let e=null;for(const a of t){const t=this.generateConditions(a.tweak.conditions,"name","def",a.variables),o=t.join(" && ");e&&e.conditions.join(" && ")===o?e.inputs.push(a):(e&&this.emitGroup(e,"def"),e={inputs:[a],conditions:t})}e&&this.emitGroup(e,"def"),this.endBlock()}if(a.length>0){const e="ApplyTweaks_Post";this.startBlock(`local function ${e}(name, def)`);let t=null;for(const e of a){const a=this.generateConditions(e.tweak.conditions,"name","def",e.variables),o=a.join(" && ");t&&t.conditions.join(" && ")===o?t.inputs.push(e):(t&&this.emitGroup(t,"def"),t={inputs:[e],conditions:a})}t&&this.emitGroup(t,"def"),this.endBlock(),this.addStatement(""),this.startIf("UnitDef_Post"),this.addLocal("prev_UnitDef_Post","UnitDef_Post"),this.startBlock("UnitDef_Post = function(name, def)"),this.addStatement("prev_UnitDef_Post(name, def)"),this.addStatement(`${e}(name, def)`),this.endBlock(),this.addElse(),this.addStatement(`UnitDef_Post = ${e}`),this.endBlock()}return this.builder.map(e=>e.trim()).filter(e=>""!==e&&!e.startsWith("--")).join("\n")}emitGroup(e,t){e.conditions.length>0&&this.startIf(e.conditions.join(" and "));const a=[];e.inputs.forEach(e=>e.tweak.mutations.forEach(t=>a.push({mut:t,vars:e.variables})));const o=[];for(const e of a){const t=o.length>0?o[o.length-1]:null;t&&"multiply"===t.mut.op&&"multiply"===e.mut.op&&(t.mut.field,e.mut.field),o.push(e)}const n=new Map,l=(e,a)=>{const o=a.join(" * "),n=e.split(".");if("customparams"===n[0].toLowerCase()&&n.length>1){const e=n[1];this.startIf(`${t}.customparams and ${t}.customparams["${e}"]`),this.addStatement(`${t}.customparams["${e}"] = ${t}.customparams["${e}"] * (${o})`),this.addElse(),this.startIf(`${t}.customParams and ${t}.customParams["${e}"]`),this.addStatement(`${t}.customParams["${e}"] = ${t}.customParams["${e}"] * (${o})`),this.endBlock(),this.endBlock()}else this.addStatement(`${t}.${e} = ${t}.${e} * (${o})`)},s=e=>{if(e)n.has(e)&&(l(e,n.get(e)),n.delete(e));else{for(const[e,t]of n)l(e,t);n.clear()}};for(const e of o){const{mut:a,vars:o}=e;if("set"!==a.op&&"assign_math_floor"!==a.op&&"remove"!==a.op||("field"in a&&s(a.field),"target"in a&&s(a.target)),"multiply"===a.op){const e=this.resolveValueSource(a.factor,o);n.has(a.field)||n.set(a.field,[]),n.get(a.field).push(e)}else s(),this.generateMutation(a,t,o)}s(),e.conditions.length>0&&this.endBlock()}generateMutation(e,t,a){if("set"===e.op)this.addFieldWrite(t,e.field,this.resolveValueSource(e.value,a));else if("multiply"===e.op){const o=this.resolveValueSource(e.factor,a);this.addFieldWrite(t,e.field,`${this.getFieldRead(t,e.field)} * (${o})`)}else if("remove"===e.op)this.addFieldWrite(t,e.field,"nil");else if("assign_math_floor"===e.op){const o=this.getFieldRead(t,e.source);this.startIf(o);const n=this.resolveValueSource(e.factor,a);this.addFieldWrite(t,e.target,`math_floor(${o} * ${n})`),this.endBlock()}else if("list_append"===e.op){const o=this.resolveValueSource(e.value,a),n="target_list";this.addLocal(n,this.getFieldRead(t,e.field)),this.startIf(`not ${n}`);const l=e.field.split(".");"customparams"===l[0].toLowerCase()&&l.length>1?(this.addStatement(`${t}.customparams = ${t}.customparams or {}`),this.addStatement(`${t}.customparams["${l[1]}"] = {}`),this.addStatement(`${n} = ${t}.customparams["${l[1]}"]`)):(this.addStatement(`${t}.${e.field} = {}`),this.addStatement(`${n} = ${t}.${e.field}`)),this.endBlock(),this.addStatement(`table_insert(${n}, ${o})`)}else if("modify_weapon"===e.op){const o=e.weaponName||"*";this.startIf(`${t}.weapondefs`),this.startLoop(`for wName, wDef in pairs(${t}.weapondefs)`),"*"!==o&&this.startIf(`wName == "${o}"`);for(const t of e.mutations)this.generateMutation(t,"wDef",a);"*"!==o&&this.endBlock(),this.endBlock(),this.endBlock()}else if("table_merge"===e.op){const o=this.resolveValueSource(e.value,a),n=e.field.split(".");if("customparams"===n[0].toLowerCase()&&n.length>1){const e=n[1];this.addStatement(`if not ${t}.customparams then ${t}.customparams = {} end`),this.addStatement(`if not ${t}.customparams["${e}"] then ${t}.customparams["${e}"] = {} end`),this.addStatement(`table_merge(${t}.customparams["${e}"], ${o})`)}else this.addStatement(`if not ${t}.${e.field} then ${t}.${e.field} = {} end`),this.addStatement(`table_merge(${t}.${e.field}, ${o})`)}else if("list_remove"===e.op){const o=this.resolveValueSource(e.value,a),n="target_list";this.addLocal(n,this.getFieldRead(t,e.field)),this.startIf(n),this.startLoop(`for i = #(${n}), 1, -1`),this.startIf(`${n}[i] == ${o}`),this.addStatement(`table_remove(${n}, i)`),this.endBlock(),this.endBlock(),this.endBlock()}else if("clone_unit"===e.op){const o="SELF"===e.source?t:`UnitDefs["${e.source}"]`,n=e.target?`"${e.target}"`:e.targetSuffix?`${t}.name .. "${e.targetSuffix}"`:"nil";if(this.startIf(o),this.addLocal("newDef",`table_merge({}, ${o})`),e.mutations)for(const t of e.mutations)this.generateMutation(t,"newDef",a);this.addStatement(`UnitDefs[${n}] = newDef`),this.endBlock()}}generateConditions(e,t,a,o){const n=[];for(const l of e)switch(l.type){case"nameMatch":n.push(`string_match(${t}, "${l.regex}")`);break;case"nameNotMatch":n.push(`not string_match(${t}, "${l.regex}")`);break;case"nameStartsWith":if("string"==typeof l.prefix?l.prefix:this.resolveValueSource(l.prefix,o).replace(/"/g,""),"string"!=typeof l.prefix){const e=this.resolveValueSource(l.prefix,o);n.push(`string_sub(${t}, 1, string_len(${e})) == ${e}`)}else n.push(`string_sub(${t}, 1, ${l.prefix.length}) == "${l.prefix}"`);break;case"nameEndsWith":if("string"!=typeof l.suffix){const e=this.resolveValueSource(l.suffix,o);n.push(`string_sub(${t}, -string_len(${e})) == ${e}`)}else n.push(`string_sub(${t}, -${l.suffix.length}) == "${l.suffix}"`);break;case"customParam":const e="object"==typeof l.value?this.resolveValueSource(l.value,o):"string"==typeof l.value?`"${l.value}"`:l.value;n.push(`((${a}.customParams and ${a}.customParams["${l.key}"] == ${e}) or (${a}.customparams and ${a}.customparams["${l.key}"] == ${e}))`);break;case"customParamMatch":n.push(`((${a}.customParams and ${a}.customParams["${l.key}"] and string_match(${a}.customParams["${l.key}"], "${l.regex}")) or (${a}.customparams and ${a}.customparams["${l.key}"] and string_match(${a}.customparams["${l.key}"], "${l.regex}")))`);break;case"fieldValue":const s="object"==typeof l.value?this.resolveValueSource(l.value,o):"string"==typeof l.value?`"${l.value}"`:l.value;n.push(`${this.getFieldRead(a,l.field)} == ${s}`);break;case"category":const i="object"==typeof l.value?this.resolveValueSource(l.value,o):`"${l.value}"`;n.push(`string_match(${a}.category or "", ${i})`);break;case"nameInList":const r=l.names.map(e=>`${t} == "${e}"`);n.push(`(${r.join(" or ")})`)}return n}resolveValueSource(e,t){if("object"==typeof e&&null!==e){if("type"in e){const a=e;if("variable"===a.type){const e=t[a.key];if(void 0===e)throw new Error(`Variable ${a.key} not found`);return this.jsonToLua(e,t)}if("mod_option"===a.type)return`(Spring_GetModOptions().${a.key} or ${this.jsonToLua(a.default,t)})`;if("math"===a.type){let e=a.expression;for(const[o,n]of Object.entries(a.variables)){let a=this.resolveValueSource(n,t);if(a.startsWith('"')&&a.endsWith('"')){const e=a.slice(1,-1);/^[a-zA-Z_][a-zA-Z0-9_.]*$/.test(e)&&(a=e)}e=e.split(o).join(a)}return`(${this.transformMathExpression(e).code})`}}return this.jsonToLua(e,t)}return this.jsonToLua(e,t)}transformMathExpression(e){const t=new Set,a=e.split(/("(?:\\[\s\S]|[^"])*"|'(?:\\[\s\S]|[^'])*')/g);for(let e=0;e<a.length;e+=2)a[e]=a[e].replace(/\b(max|min|ceil|floor|abs|random|sqrt)(\s*\()/g,(e,a,o)=>(t.add(`math.${a}`),`math_${a}${o}`));return{code:a.join(""),globals:t}}escapeLuaString(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\r/g,"\\r")}jsonToLua(e,t){if(null==e)return"nil";if("object"==typeof e&&null!==e&&"type"in e&&("variable"===e.type||"math"===e.type||"mod_option"===e.type))return this.resolveValueSource(e,t);if("string"==typeof e)return`"${this.escapeLuaString(e)}"`;if("number"==typeof e)return e.toString();if("boolean"==typeof e)return e?"true":"false";if(Array.isArray(e))return`{ ${e.map(e=>this.jsonToLua(e,t)).join(", ")} }`;if("object"==typeof e){const a=[];for(const o in e)if(Object.prototype.hasOwnProperty.call(e,o)){const n=/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(o)?o:`["${o}"]`;a.push(`${n} = ${this.jsonToLua(e[o],t)}`)}return`{ ${a.join(", ")} }`}return"{}"}scanGlobals(e){this.usedGlobals.add("pairs"),this.usedGlobals.add("ipairs"),this.usedGlobals.add("string.sub"),this.usedGlobals.add("string.match"),this.usedGlobals.add("string.len"),this.usedGlobals.add("table.insert"),this.usedGlobals.add("math.floor");for(const t of e)this.scanValueSource(t.tweak,t.variables)}scanValueSource(e,t){if(e&&"object"==typeof e){"mod_option"===e.type&&this.usedGlobals.add("Spring.GetModOptions"),"math"===e.type&&this.transformMathExpression(e.expression).globals.forEach(e=>this.usedGlobals.add(e)),"table_merge"!==e.type&&"clone_unit"!==e.type&&"table_merge"!==e.op&&"clone_unit"!==e.op||this.usedGlobals.add("table.merge"),"list_remove"===e.op&&this.usedGlobals.add("table.remove");for(const a in e)this.scanValueSource(e[a],t)}}emitGlobals(){this.usedGlobals.has("Spring.GetModOptions")&&this.addLocal("Spring_GetModOptions","Spring.GetModOptions"),this.usedGlobals.has("table.merge")&&this.addLocal("table_merge","table.merge");const e={pairs:"pairs",ipairs:"ipairs","string.sub":"string_sub","string.match":"string_match","string.len":"string_len","table.insert":"table_insert","table.remove":"table_remove","math.floor":"math_floor","math.ceil":"math_ceil","math.max":"math_max","math.min":"math_min","math.abs":"math_abs","math.random":"math_random","math.sqrt":"math_sqrt"};for(const t of this.usedGlobals)e[t]&&this.addLocal(e[t],t)}getIndent(){return"    ".repeat(this.indentLevel)}addStatement(e){this.builder.push(this.getIndent()+e)}addLocal(e,t){this.builder.push(`${this.getIndent()}local ${e} = ${t}`)}startLoop(e){this.builder.push(`${this.getIndent()}${e} do`),this.indentLevel++}startIf(e){this.builder.push(`${this.getIndent()}if ${e} then`),this.indentLevel++}addElse(){this.indentLevel--,this.builder.push(`${this.getIndent()}else`),this.indentLevel++}startBlock(e){this.builder.push(`${this.getIndent()}${e}`),this.indentLevel++}endBlock(){this.indentLevel--,this.builder.push(`${this.getIndent()}end`)}getFieldRead(e,t){const a=t.split(".");if("customparams"===a[0].toLowerCase()&&a.length>1){const t=a[1];return`((${e}.customParams and ${e}.customParams["${t}"]) or (${e}.customparams and ${e}.customparams["${t}"]))`}return`${e}.${t}`}addFieldWrite(e,t,a){const o=t.split(".");if("customparams"===o[0].toLowerCase()&&o.length>1){const t=o[1];this.startIf(`${e}.customparams`),this.addStatement(`${e}.customparams["${t}"] = ${a}`),this.addElse(),this.addStatement(`if not ${e}.customParams then ${e}.customParams = {} end`),this.addStatement(`${e}.customParams["${t}"] = ${a}`),this.endBlock()}else this.addStatement(`${e}.${t} = ${a}`)}}const u=[{tier:2,hpMult:16,outputMult:4.2,costMult:4,prevSuffix:""},{tier:3,hpMult:16,outputMult:4.2,costMult:4,prevSuffix:"_t2"},{tier:4,hpMult:16,outputMult:4.2,costMult:4,prevSuffix:"_t3"},{tier:5,hpMult:16,outputMult:4.2,costMult:4,prevSuffix:"_t4"}],p=[{name:"armsolar",label:"Solar Collector"},{name:"corsolar",label:"Solar Collector"},{name:"armwin",label:"Wind Generator"},{name:"corwin",label:"Wind Generator"},{name:"armmakr",label:"Metal Maker"},{name:"cormakr",label:"Metal Maker"},{name:"armllt",label:"Light Laser Tower"},{name:"corllt",label:"Light Laser Tower"}],h=[{suffix:"_compressed_x2",mult:2,label:"x2"},{suffix:"_compressed_x5",mult:5,label:"x5"},{suffix:"_compressed_x10",mult:10,label:"x10"}],f=["raptor_land_swarmer_basic_t1_v1","raptor_land_assault_basic_t2_v1","raptor_air_fighter_basic","raptor_hive_swarmer_basic","raptor_hive_assault_basic"],b=d;function y(e){const{gameConfigs:t,formOptionsConfig:a,mapsSelectValue:o,modesSelectValue:n,primaryModeSelectValue:l,scavHpSelectValue:s,scavHpSelectText:i,bossHpSelectValue:r,bossHpSelectText:c,formElements:d,raptorOptions:y}=e,v=[];if(""!==o){const e=t.maps[parseInt(o)];e&&e.commands&&v.push(...e.commands)}if(""!==n){const e=t.modes[parseInt(n)];e&&e.commands&&v.push(...e.commands)}const g=[],k=[],_=[];if(d.forEach(e=>{if(e.isCustom)e.checked&&e.customData&&k.push(e.customData);else if(e.tweakDefinition&&e.checked)_.push({tweak:e.tweakDefinition,variables:{}});else if(e.isHpGenerator||e.isScavHpGenerator){const t=parseFloat(e.value||"0");if(t>0){const a=e.hpType;if("qhp"===a)b.qhp&&_.push({tweak:b.qhp,variables:{multiplier:t,multiplierText:e.value}});else if("hp"===a){let a=1,o=.5;switch(t){case 1.3:a=.576923077,o=.5;break;case 1.5:a=.466666667,o=.5;break;case 1.7:a=.411764706,o=.5;break;case 2:a=.35,o=.5;break;case 2.5:a=.3,o=.6;break;case 3:a=.25,o=.55;break;case 4:a=.1875,o=.45;break;case 5:a=.15,o=.25;break;default:a=1,o=.5}b.raptor_swarmer_heal&&_.push({tweak:b.raptor_swarmer_heal,variables:{workertimeMultiplier:o,multiplierText:e.value}}),b.raptor_health&&_.push({tweak:b.raptor_health,variables:{healthMultiplier:t,multiplierText:e.value}}),b.raptor_metal_chase&&_.push({tweak:b.raptor_metal_chase,variables:{metalCostFactor:a,multiplierText:e.value}})}else"boss"===a?b.boss_hp&&_.push({tweak:b.boss_hp,variables:{multiplier:t,multiplierText:e.value}}):"scav"===a&&(b.scav_hp_health&&_.push({tweak:b.scav_hp_health,variables:{multiplier:t,multiplierText:e.value}}),b.scav_hp_metal&&_.push({tweak:b.scav_hp_metal,variables:{multiplier:t,multiplierText:e.value}}))}}else{let t=[];if("SELECT"!==e.tagName||e.id.includes("maps-select")||e.id.includes("modes-select")||e.id.includes("primary-mode-select")?e.checked&&e.commandBlocks&&(t=e.commandBlocks):e.value&&t.push(e.value),e.dataset.tweakTemplateId){const t=e.dataset.tweakTemplateId;if(b[t]){let a={};if(e.dataset.tweakVars)try{a=JSON.parse(e.dataset.tweakVars)}catch(e){console.error("Error parsing tweakVars JSON:",e)}else e.dataset.tweakVar&&e.value&&(a={[e.dataset.tweakVar]:parseFloat(e.value)||e.value});_.push({tweak:b[t],variables:a})}}e.dataset.modOption&&("checkbox"===e.type?t.push(`!bset ${e.dataset.modOption} ${e.checked?"1":"0"}`):e.value&&t.push(`!bset ${e.dataset.modOption} ${e.value}`)),t.forEach(e=>{e&&g.push(e.trim())})}}),g.includes("!bset fusion_mode 1")&&function(){const e=[];for(const t of p)for(const a of u){const o=2===a.tier?t.name:`${t.name}${a.prevSuffix}`,n=`${t.name}_t${a.tier}`,l=[{op:"multiply",field:"health",factor:a.hpMult},{op:"multiply",field:"metalCost",factor:a.costMult},{op:"multiply",field:"energyCost",factor:a.costMult},{op:"multiply",field:"buildTime",factor:a.costMult},{op:"multiply",field:"energyMake",factor:a.outputMult},{op:"multiply",field:"metalMake",factor:a.outputMult},{op:"multiply",field:"windGenerator",factor:a.outputMult},{op:"modify_weapon",weaponName:"*",mutations:[{op:"multiply",field:"damage.default",factor:a.outputMult}]},{op:"multiply",field:"footprintX",factor:1.5},{op:"multiply",field:"footprintZ",factor:1.5},{op:"set",field:"name",value:`${t.label} T${a.tier}`},{op:"table_merge",field:"customParams",value:{is_fusion_unit:!0,fusion_tier:a.tier,model_scale:1.5}}];e.push({name:`Generate ${n}`,description:`Generates T${a.tier} variant of ${t.name}`,scope:"Global",conditions:[],mutations:[{op:"clone_unit",source:o,target:n,mutations:l}]})}return e}().forEach(e=>_.push({tweak:e,variables:{}})),g.includes("!bset adaptive_spawner 1")&&function(){const e=[],t=[...f.map(e=>({name:e,label:e})),...p];for(const a of t)for(const t of h){const o=`${a.name}${t.suffix}`,n=t.mult>=5?1.5:1.2,l=[{op:"multiply",field:"health",factor:t.mult},{op:"multiply",field:"metalCost",factor:t.mult},{op:"multiply",field:"energyCost",factor:t.mult},{op:"multiply",field:"buildTime",factor:t.mult},{op:"multiply",field:"mass",factor:t.mult},{op:"multiply",field:"energyMake",factor:t.mult},{op:"multiply",field:"metalMake",factor:t.mult},{op:"multiply",field:"windGenerator",factor:t.mult},{op:"modify_weapon",weaponName:"*",mutations:[{op:"multiply",field:"damage.default",factor:t.mult},{op:"multiply",field:"areaOfEffect",factor:Math.sqrt(t.mult)}]},{op:"set",field:"name",value:`${a.label} ${t.label}`},{op:"table_merge",field:"customParams",value:{is_compressed_unit:!0,compression_factor:t.mult,model_scale:n,color_tint:"1 0.5 0.5"}}];t.mult>=5&&(l.push({op:"multiply",field:"footprintX",factor:1.5}),l.push({op:"multiply",field:"footprintZ",factor:1.5})),e.push({name:`Generate ${o}`,description:`Generates ${t.label} compressed variant of ${a.name}`,scope:"Global",conditions:[],mutations:[{op:"clone_unit",source:a.name,target:o,mutations:l}]})}return e}().forEach(e=>_.push({tweak:e,variables:{}})),_.length>0){const e=(new m).compile(_),t={valid:!0};if(t.valid){const t=unescape(encodeURIComponent(e)),a=btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"");k.unshift({id:0,desc:"Optimized Config",type:"tweakdefs",tweak:a})}else console.error(`Lua validation failed for generated config: ${t.error}`)}const x=new Set,w=new Set,$=/!bset\s+(tweakdefs|tweakunits)([1-9])\b/;[...g].forEach(e=>{const t=e.match($);if(t){const e=parseInt(t[2],10);"tweakdefs"===t[1]?x.add(e):"tweakunits"===t[1]&&w.add(e)}});const S=[];k.forEach(e=>{const t="tweakdefs"===e.type?x:w;let a=null;for(let e=1;e<=9;e++)if(!t.has(e)){a=e;break}null!==a?(S.push(`!bset ${e.type}${a} ${e.tweak}`),t.add(a)):console.warn(`All slots for '${e.type}' are full. Could not add custom tweak.`)});const E=v.length>0||g.length>0||S.length>0,C=[],L=v.length>0||g.length>0||S.length>0,T=!1!==e.isMainTweaksEnabled;L&&(T&&t.base.length>0&&C.push(...t.base),"Scavengers"===l&&t.scavengers.length>0&&C.push(...t.scavengers)),C.push(...v,...g,...S);const B="Scavengers"===l;let P=B?"$rename [Mod] NuttyB Scavengers ":"$rename [Mod] NuttyB Raptors ";const H=[];if(B){const e=[i,c].filter(Boolean).join(" ");if(e){const t=e.replace(/\./g,"_");H.push(`[${t}]`)}}else{let e="",t="",o="";y.forEach(n=>{if(n.value){const l=a.find(e=>e.label===n.optionType);if(l&&l.choices){const a=l.choices.find(e=>e.value===n.value);a&&void 0!==a.shortLabel&&("Extras"===l.label?e=a.shortLabel:"Raptor Health"===l.label?t=a.shortLabel:"Queen Health"===l.label&&(o=a.shortLabel))}}}),e&&H.push(e);const n=[o,t].filter(Boolean).join(" ");n&&H.push(`[${n}]`)}const M=C.lastIndexOf("!unit_restrictions_noextractors 1"),I=C.lastIndexOf("!unit_restrictions_noextractors 0"),V=M>-1&&M>I;H.length>0&&(P+=H.join("")),V&&(P+="[No Mex]");const O=[],N=C;for(const e of N){if(!e)continue;let t=!1;for(const a of O){const o=0===a.length?e.length:e.length+1;if(a.length+o<=5e4){a.commands.push(e),a.length+=o,t=!0;break}}t||O.push({commands:[e],length:e.length})}if(E)if(0===O.length)O.push({commands:[P],length:P.length});else{const e=O[O.length-1],t=0===e.length?P.length:P.length+1;e.length+t<=5e4?(e.commands.push(P),e.length+=t):O.push({commands:[P],length:P.length})}return{lobbyName:E?P:"No Options Selected",sections:O.map(e=>e.commands.join("\n"))}}const v=d;function g(e){const t=document.querySelector("#custom-tweaks-table tbody");t.innerHTML="",0!==e.length?e.forEach(e=>{t.insertRow().innerHTML=`<td title="${e.desc}">${e.desc}</td><td title="${e.type}">${e.type}</td><td><div class="command-cell-wrapper"><span class="command-text" title="${e.tweak}">${e.tweak}</span><button class="copy-row-button" data-tweak-code="${e.tweak}">Copy</button></div></td><td><button class="delete-tweak-btn" data-id="${e.id}">Delete</button></td>`}):t.innerHTML='<tr><td colspan="4" style="text-align: center;">No custom tweaks saved</td></tr>'}function k(e){const t=document.querySelector("#data-table tbody");t.innerHTML="",e.filter(e=>"Hidden"!==e.status).forEach(e=>{const a=t.insertRow();a.insertCell().textContent=e.label,a.insertCell().textContent=e.status,a.insertCell().textContent=e.summary;const o=a.insertCell(),n=document.createElement("div");n.className="command-cell-wrapper";const l=document.createElement("span");l.className="command-text",l.textContent=e.commandBlock,l.title=e.commandBlock;const s=document.createElement("button");s.textContent="Copy",s.className="copy-row-button",s.dataset.command=e.commandBlock,n.appendChild(l),n.appendChild(s),o.appendChild(n)}),document.querySelectorAll("select[data-slot]").forEach(e=>{const a=e,o=a.value;if(!o)return;const n=a.options[a.selectedIndex].text,l=a.dataset.hpType,s=a.dataset.slot,i=`${a.dataset.slotType}${s}`,r=function(e,t){const a=parseFloat(t);if(isNaN(a))return"Error: Invalid multiplier";try{const o=[];if("qhp"===e)v.qhp&&o.push({tweak:v.qhp,variables:{multiplier:a,multiplierText:t}});else if("boss"===e)v.boss_hp&&o.push({tweak:v.boss_hp,variables:{multiplier:a,multiplierText:t}});else if("hp"===e){let e=1,n=.5;switch(a){case 1.3:e=.576923077,n=.5;break;case 1.5:e=.466666667,n=.5;break;case 1.7:e=.411764706,n=.5;break;case 2:e=.35,n=.5;break;case 2.5:e=.3,n=.6;break;case 3:e=.25,n=.55;break;case 4:e=.1875,n=.45;break;case 5:e=.15,n=.25;break;default:e=1,n=.5}v.raptor_swarmer_heal&&o.push({tweak:v.raptor_swarmer_heal,variables:{workertimeMultiplier:n,multiplierText:t}}),v.raptor_health&&o.push({tweak:v.raptor_health,variables:{healthMultiplier:a,multiplierText:t}}),v.raptor_metal_chase&&o.push({tweak:v.raptor_metal_chase,variables:{metalCostFactor:e,multiplierText:t}})}else{if("scav"!==e)return"Error: Unknown type";v.scav_hp_health&&o.push({tweak:v.scav_hp_health,variables:{multiplier:a,multiplierText:t}}),v.scav_hp_metal&&o.push({tweak:v.scav_hp_metal,variables:{multiplier:a,multiplierText:t}})}if(o.length>0){const e=(new m).compile(o);let t=e;if("undefined"!=typeof luamin){const a=e.match(/^(--.*)\n/),o=a?a[1]:"",n=luamin.minify(e);t=o?o+"\n"+n:n}return function(e){const t=unescape(encodeURIComponent(e));return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}(t)}}catch(e){return"Error: "+e}return"Error: Unknown type"}(l,o);if(r.startsWith("Error"))return;const c=`!bset ${i} ${r}`,d=function(e){if(!e)return"";try{let t=e.replace(/-/g,"+").replace(/_/g,"/");const a=t.length%4;a&&(t+="====".slice(a));const o=atob(t),n=Uint8Array.from(o,e=>e.charCodeAt(0));return new TextDecoder("utf-8").decode(n)}catch(t){return console.error(`Base64URL decoding failed for: ${e}`,t),"Error decoding data"}}(r).split("\n")[0].trim(),u=t.insertRow();u.insertCell().textContent=n,u.insertCell().textContent="Optional/Generated",u.insertCell().textContent=d;const p=u.insertCell(),h=document.createElement("div");h.className="command-cell-wrapper";const f=document.createElement("span");f.className="command-text",f.textContent=c,f.title=c;const b=document.createElement("button");b.textContent="Copy",b.className="copy-row-button",b.dataset.command=c,h.appendChild(f),h.appendChild(b),p.appendChild(h)})}let _=[],x=[],w={maps:[],modes:[],base:[],scavengers:[]};const $=document.getElementById("lobby-name-display"),S=(document.querySelectorAll(".copy-button"),document.querySelector("#data-table tbody")),E=document.getElementById("custom-tweak-form"),C=document.querySelector("#custom-tweaks-table tbody"),L=document.querySelector("#maps-modes-table tbody"),T=document.querySelectorAll(".tab-button"),B=document.querySelectorAll(".tab-content"),P=document.getElementById("reset-none-btn"),H=document.getElementById("reset-default-btn"),M=document.getElementById("options-form-columns");function I(e){const t=document.getElementById("primary-mode-select"),a=document.getElementById("raptor-only-options"),o=document.getElementById("scav-only-options"),n=document.getElementById("scav-hp-select"),l=document.getElementById("boss-hp-select"),s=document.getElementById("maps-select"),i=document.getElementById("modes-select");if(t&&a&&o){const s=t.value;e&&e.target===t&&("Scavengers"===s?(n.value="1.3",l.value="1.3",a.querySelectorAll("select, input").forEach(e=>e.value="")):(n.value="",l.value="",a.querySelectorAll("select, input").forEach(e=>{const t=e;let a=x.find(e=>e.label===t.dataset.optionType);!a&&t.dataset.modOption&&(a=x.find(e=>e.modOption===t.dataset.modOption)),!a&&t.dataset.tweakTemplateId&&(a=x.find(e=>e.tweakTemplateId===t.dataset.tweakTemplateId)),a&&(e.value=a.defaultValue||"")})));const i="Scavengers"===s;a.style.display=i?"none":"block",o.style.display=i?"block":"none"}!function(){const e=document.getElementById("slot-warning-messages"),t=new Set,a=new Set,o=/!bset\s+(tweakdefs|tweakunits)([1-9])\b/;document.querySelectorAll('#options-form-columns input[type="checkbox"], #options-form-columns select').forEach(e=>{const n=e;if(n.dataset.isCustom)return;if((n.dataset.isHpGenerator||n.dataset.isScavHpGenerator)&&n.value&&n.dataset.slot){const e=parseInt(n.dataset.slot,10);return void(isNaN(e)||("tweakdefs"===n.dataset.slotType?t.add(e):"tweakunits"===n.dataset.slotType&&a.add(e)))}let l=[];"SELECT"===n.tagName&&n.value?l.push(n.value):"checkbox"===n.type&&n.checked&&(l=JSON.parse(n.dataset.commandBlocks||"[]")),l.forEach(e=>{if(!e)return;const n=e.match(o);if(n){const e=parseInt(n[2],10);"tweakdefs"===n[1]?t.add(e):"tweakunits"===n[1]&&a.add(e)}})});const n=document.querySelectorAll('input[data-is-custom="true"]');n.forEach(e=>{const o=e,n=o.nextElementSibling.nextElementSibling,l=o.nextElementSibling,s=JSON.parse(o.dataset.customData);if(l.classList.remove("disabled"),o.checked){const e="tweakdefs"===s.type?t:a;let o=null;for(let t=1;t<=9;t++)if(!e.has(t)){o=t;break}null!==o?(n.textContent=`(${s.type}${o})`,e.add(o)):n.textContent=`(${s.type} - No Slot!)`}else n.textContent=`(${s.type})`});let l=9-t.size,s=9-a.size;n.forEach(e=>{const t=e;if(!t.checked){const e=JSON.parse(t.dataset.customData);let a=!1;"tweakdefs"===e.type&&l<=0&&(a=!0),"tweakunits"===e.type&&s<=0&&(a=!0),t.disabled=a,t.nextElementSibling.classList.toggle("disabled",a)}}),e.innerHTML="";const i=1===Math.max(0,l)?"slot":"slots",r=1===Math.max(0,s)?"slot":"slots",c=document.createElement("p");c.textContent=`${Math.max(0,l)} available tweakdefs ${i} and ${Math.max(0,s)} available tweakunits ${r}`,e.appendChild(c)}();const r=Array.from(document.querySelectorAll('#options-form-columns input[type="checkbox"], #options-form-columns input[type="number"], #options-form-columns select, #custom-options-form-columns input[type="checkbox"]')).map(e=>{const t=e;return{isCustom:"true"===t.dataset.isCustom,customData:t.dataset.customData?JSON.parse(t.dataset.customData):void 0,isHpGenerator:"true"===t.dataset.isHpGenerator,isScavHpGenerator:"true"===t.dataset.isScavHpGenerator,value:t.value,checked:t.checked,hpType:t.dataset.hpType,slot:t.dataset.slot,slotType:t.dataset.slotType,tagName:t.tagName,type:t.type,id:t.id,dataset:t.dataset,commandBlocks:t.dataset.commandBlocks?JSON.parse(t.dataset.commandBlocks):void 0}}),c=Array.from(document.querySelectorAll("#raptor-only-options select")).map(e=>({value:e.value,optionType:e.dataset.optionType||""})),d=document.querySelector('input[data-option-label="NuttyB Main Tweaks"]'),m=y({isMainTweaksEnabled:!d||d.checked,gameConfigs:w,formOptionsConfig:x,mapsSelectValue:s?s.value:"",modesSelectValue:i?i.value:"",primaryModeSelectValue:t?t.value:"Raptors",scavHpSelectValue:n?n.value:"",scavHpSelectText:n&&n.options[n.selectedIndex]?n.options[n.selectedIndex].text:"",bossHpSelectValue:l?l.value:"",bossHpSelectText:l&&l.options[l.selectedIndex]?l.options[l.selectedIndex].text:"",formElements:r,raptorOptions:c});$.textContent=m.lobbyName;for(let e=1;e<=7;e++){const t=document.getElementById(`part-${e}-section`),a=document.getElementById(`command-output-${e}`);m.sections[e-1]?(a.value=m.sections[e-1],t.style.display="grid"):(a.value="",t.style.display="none")}}function V(e){const t=e.target,a=t.dataset.tab+"-tab";T.forEach(e=>e.classList.remove("active")),B.forEach(e=>e.classList.remove("active")),t.classList.add("active"),document.getElementById(a).classList.add("active"),"data"===t.dataset.tab&&(k(_),function(e){const t=document.querySelector("#maps-modes-table tbody");if(t.innerHTML="",0===e.maps.length&&0===e.modes.length&&0===e.scavengers.length&&0===e.base.length)return void(t.innerHTML='<tr><td colspan="3" style="text-align: center;">No maps or modes found.</td></tr>');const a=(e,t)=>{if(!t||0===t.length)return void(e.textContent="N/A");const a=document.createElement("div");a.className="command-cell-wrapper";const o=document.createElement("span");o.style.whiteSpace="normal",o.innerHTML=t.join("<br>");const n=document.createElement("button");n.textContent="Copy All",n.className="copy-row-button",n.dataset.command=t.join("\n"),a.appendChild(o),a.appendChild(n),e.appendChild(a)},o=(e,o)=>{e.forEach(e=>{const n=t.insertRow();n.insertCell().textContent=o,n.insertCell().textContent=e.name,a(n.insertCell(),e.commands)})},n=(e,o,n)=>{if(e.length>0){const l=t.insertRow();l.insertCell().textContent=o,l.insertCell().textContent=n,a(l.insertCell(),e)}};n(e.base,"base","Raptors (Default)"),n(e.scavengers,"scavengers","Default"),o(e.maps,"maps"),o(e.modes,"modes")}(w)),"custom"===t.dataset.tab&&g(c())}function O(){g(c()),function(e,t){const a=document.getElementById("custom-left-column"),o=document.getElementById("custom-right-column"),n=document.getElementById("custom-settings-container");a.innerHTML="",o.innerHTML="",e.length>0?(n.style.display="block",e.forEach((e,n)=>{const l=document.createElement("label"),s=document.createElement("input");s.type="checkbox",s.dataset.isCustom="true",s.dataset.customData=JSON.stringify({type:e.type,tweak:e.tweak}),s.addEventListener("change",t);const i=document.createElement("span");i.className="custom-option-label-text",i.textContent=` ${e.desc}`;const r=document.createElement("span");r.className="custom-option-type-display",r.textContent=`(${e.type})`,l.appendChild(s),l.appendChild(i),l.appendChild(r),n%2==0?a.appendChild(l):o.appendChild(l)})):n.style.display="none"}(c(),I)}document.addEventListener("click",e=>{const t=e.target;if(t.matches(".copy-button")){const e=t.dataset.target;if(!e)return;const a=document.getElementById(e);if(!a)return;const o=t.textContent;navigator.clipboard.writeText(a.value).then(()=>{t.textContent="Copied!",setTimeout(()=>{t.textContent=o},2e3)}).catch(e=>{console.error("Failed to copy: ",e)})}}),[S,C,L].forEach(e=>{e&&e.addEventListener("click",e=>{const t=e.target;if(t.matches(".copy-row-button")){const e=t.dataset.command||t.dataset.tweakCode;if(!e)return;navigator.clipboard.writeText(e).then(()=>{const e=t.textContent;t.textContent="Copied!",setTimeout(()=>{t.textContent=e},2e3)}).catch(e=>{console.error("Failed to copy command: ",e)})}else t.matches(".delete-tweak-btn")&&(function(e){i=i.filter(t=>t.id!==e),r(i)}(parseInt(t.dataset.id,10)),O(),I())})}),P.addEventListener("click",()=>{document.querySelectorAll('#options-form-columns input[type="checkbox"], #options-form-columns input[type="number"], #options-form-columns select').forEach(e=>{const t=e;if("checkbox"===t.type)t.checked=!1;else if("SELECT"===t.tagName)"maps-select"===t.id||"modes-select"===t.id?t.selectedIndex=-1:"primary-mode-select"!==t.id&&(t.value="");else if("number"===t.type){const e=t.dataset.tweakTemplateId;if(e){const a=x.find(t=>t.tweakTemplateId===e);t.value=a&&a.defaultValue||""}else t.value=""}}),I()}),H.addEventListener("click",()=>{const e=document.getElementById("primary-mode-select");e&&(e.value="Raptors");const t=new Map;document.querySelectorAll("#options-form-columns label").forEach(e=>{var a;const o=null===(a=e.textContent)||void 0===a?void 0:a.trim();o&&t.set(o,e)}),x.forEach(e=>{if("checkbox"===e.type){const a=t.get(e.label);if(a){const t=a.querySelector('input[type="checkbox"]');t&&(t.checked=!!e.default)}}else if("select"===e.type){const t=M.querySelector(`select[data-option-type="${e.label}"]`);t&&(t.value=e.defaultValue||"")}else if("numeric-tweak"===e.type&&e.tweakTemplateId){const t=M.querySelector(`input[data-tweak-template-id="${e.tweakTemplateId}"]`);t&&(t.value=e.defaultValue||"")}});const a=document.getElementById("boss-hp-select"),o=document.getElementById("scav-hp-select");a&&(a.value=""),o&&(o.value="");const n=document.getElementById("maps-select");n&&n.options.length>0&&(n.selectedIndex=0);const l=document.getElementById("modes-select");l&&l.options.length>0&&(l.selectedIndex=0),I()}),E.addEventListener("submit",function(e){var t,a,o;e.preventDefault(),t=document.getElementById("custom-option-desc").value.trim(),a=document.getElementById("custom-option-type").value,o=document.getElementById("custom-tweak-code").value.trim(),t&&o&&(i.push({id:Date.now(),desc:t,type:a,tweak:o}),r(i)),O(),I(),E.reset()}),T.forEach(e=>e.addEventListener("click",V)),document.addEventListener("DOMContentLoaded",function(){return e=this,t=void 0,r=function*(){try{!function(){const e=localStorage.getItem(s);i=e?JSON.parse(e):[]}();const[e,t,a]=yield Promise.all([l(),o(),n()]);if(w=e,_=t.rawOptionsData,x=t.formOptionsConfig,a){const e=document.getElementById("links-tab");e&&(e.innerHTML=a)}console.log("Modes file loaded and parsed:",w),function(e,t,a){const o=document.getElementById("left-column"),n=document.getElementById("right-column");document.getElementById("options-form-columns"),o.innerHTML="",n.innerHTML="";const l=new Map(e.map(e=>[e.label,e])),s=["NuttyB Main Tweaks","NuttyB Evolving Commanders"],i=new Set(s);s.forEach(e=>{const t=l.get(e);if(t){const e=document.createElement("label"),n=document.createElement("input");n.type="checkbox",n.dataset.commandBlocks=JSON.stringify(t.commandBlocks),t.tweakTemplateId&&(n.dataset.tweakTemplateId=t.tweakTemplateId),n.dataset.optionLabel=t.label,n.checked=!!t.default,n.disabled=!!t.disabled,e.appendChild(n),e.appendChild(document.createTextNode(" "+t.label)),n.disabled||n.addEventListener("change",a),o.appendChild(e)}});const r=document.createElement("label");r.textContent="Mode: ";const c=document.createElement("select");c.id="primary-mode-select",c.innerHTML='<option value="Raptors">Raptors</option><option value="Scavengers">Scavengers</option>',c.addEventListener("change",e=>a(e)),r.appendChild(c),o.appendChild(r);const d=document.createElement("div");d.id="scav-only-options";const m=document.createElement("label");m.textContent="Scavengers HP: ";const u=document.createElement("select");u.id="scav-hp-select",u.dataset.isScavHpGenerator="true",u.dataset.hpType="scav",u.dataset.slot="",u.dataset.slotType="tweakdefs",[{v:"",t:"Default"},{v:"1",t:"1x HP"},{v:"1.3",t:"1.3x HP"},{v:"1.5",t:"1.5x HP"},{v:"1.7",t:"1.7x HP"},{v:"2",t:"2x HP"},{v:"2.5",t:"2.5x HP"},{v:"3",t:"3x HP"},{v:"4",t:"4x HP"},{v:"5",t:"5x HP"}].forEach(e=>u.add(new Option(e.t,e.v))),u.value="",u.addEventListener("change",a),m.appendChild(u),d.appendChild(m);const p=document.createElement("label");p.textContent="Scav Boss HP: ";const h=document.createElement("select");h.id="boss-hp-select",h.dataset.isScavHpGenerator="true",h.dataset.hpType="boss",h.dataset.slot="1",h.dataset.slotType="tweakdefs",[{v:"",t:"Default"},{v:"1",t:"1x BHP"},{v:"1.3",t:"1.3x BHP"},{v:"1.5",t:"1.5x BHP"},{v:"1.7",t:"1.7x BHP"},{v:"2",t:"2x BHP"},{v:"2.5",t:"2.5x BHP"},{v:"3",t:"3x BHP"},{v:"4",t:"4x BHP"},{v:"5",t:"5x BHP"}].forEach(e=>h.add(new Option(e.t,e.v))),h.value="",h.addEventListener("change",a),p.appendChild(h),d.appendChild(p),o.appendChild(d);const f=document.createElement("div");if(f.id="raptor-only-options",o.appendChild(f),e.forEach(e=>{var t;if(i.has(e.label))return;if("Scavengers HP"===e.label||"Boss HP"===e.label)return;const l=new Set(["Raptor Health","Queen Health","Extras","Raptor Settings","Queen Quantity","Wave Multiplier","First Waves Boost","Grace Period Multiplier"]);if("header"===e.type){const t=document.createElement("h3");return t.textContent=e.label,void(l.has(e.label)||"Raptor Settings"===e.label?f.appendChild(t):"right"===e.column?n.appendChild(t):o.appendChild(t))}const s=document.createElement("label");let r;"checkbox"===e.type?(r=document.createElement("input"),r.type="checkbox",r.dataset.commandBlocks=JSON.stringify(e.commandBlocks),e.tweakTemplateId&&(r.dataset.tweakTemplateId=e.tweakTemplateId),e.modOption&&(r.dataset.modOption=e.modOption),r.dataset.optionLabel=e.label,r.checked=!!e.default,r.disabled=!!e.disabled,s.appendChild(r),s.appendChild(document.createTextNode(" "+e.label)),r.disabled||r.addEventListener("change",a)):"numeric-tweak"===e.type?(r=document.createElement("input"),r.type="number",void 0!==e.min&&(r.min=String(e.min)),void 0!==e.max&&(r.max=String(e.max)),void 0!==e.step&&(r.step=String(e.step)),r.value=e.defaultValue||"",e.tweakTemplateId&&(r.dataset.tweakTemplateId=e.tweakTemplateId),e.tweakVar&&(r.dataset.tweakVar=e.tweakVar),e.modOption&&(r.dataset.modOption=e.modOption),r.dataset.optionLabel=e.label,s.textContent=e.label+": ",s.appendChild(r),e.unitLabel&&s.appendChild(document.createTextNode(" "+e.unitLabel)),r.addEventListener("input",a)):"select"===e.type&&(r=document.createElement("select"),r.dataset.optionType=e.label,r.dataset.optionLabel=e.label,e.isHpGenerator&&(r.dataset.isHpGenerator="true",r.dataset.hpType=e.hpType,r.dataset.slot=String(e.slot),r.dataset.slotType=e.slotType,r.disabled=!0),null===(t=e.choices)||void 0===t||t.forEach(t=>{const a=document.createElement("option");a.value=t.value,a.textContent=t.label,e.defaultValue&&t.value===e.defaultValue&&(a.selected=!0),a.dataset.shortLabel=t.shortLabel||"",r.appendChild(a)}),s.textContent=e.label+": ",s.appendChild(r),r.addEventListener("change",a)),"right"===e.column?n.appendChild(s):l.has(e.label)?f.appendChild(s):o.appendChild(s)}),t&&(t.maps.length>0||t.modes.length>0)){let e,n;if(t.maps.length>0){e=document.createElement("label"),e.textContent="Map: ";const o=document.createElement("select");o.id="maps-select",t.maps.forEach((e,t)=>{o.add(new Option(e.name,String(t)))}),o.selectedIndex=0,o.addEventListener("change",a),e.appendChild(o)}if(t.modes.length>0){n=document.createElement("label"),n.textContent="Start: ";const e=document.createElement("select");e.id="modes-select",e.addEventListener("change",a),n.appendChild(e)}const l=document.getElementById("raptor-only-options");l?(n&&l.after(n),e&&l.after(e)):(e&&o.appendChild(e),n&&o.appendChild(n))}}(x,w,I);const r=()=>{console.log("Lua libraries loaded."),document.querySelectorAll('select[data-is-hp-generator="true"], select[data-is-scav-hp-generator="true"]').forEach(e=>{e.disabled=!1}),I()};if("undefined"!=typeof luamin)r();else{const e=document.querySelector('script[src*="luamin"]');e?e.addEventListener("load",r):console.error("Luamin script tag not found.")}O(),function(e,t){const a=document.getElementById("modes-select");if(!a)return;const o=a.value;a.innerHTML="",e&&e.modes&&(e.modes.forEach((e,t)=>{const o=document.createElement("option");o.value=String(t),o.textContent=e.name,a.appendChild(o)}),Array.from(a.options).some(e=>e.value===o)?a.value=o:a.options.length>0&&(a.selectedIndex=0)),t()}(w,I);const c=document.getElementById("reset-output");c&&(c.value=Array.from({length:9},(e,t)=>`!bset tweakdefs${t+1} ""\n!bset tweakunits${t+1} ""`).join("\n"))}catch(e){console.error("Failed to initialize the configurator:",e),document.querySelector(".container").innerHTML='<h1>Initialization Error</h1><p style="color: red;">Could not load essential configuration files (e.g., modes.txt or tweakdata.txt). Please check that the files exist and refresh the page.</p>'}},new((a=void 0)||(a=Promise))(function(o,n){function l(e){try{i(r.next(e))}catch(e){n(e)}}function s(e){try{i(r.throw(e))}catch(e){n(e)}}function i(e){var t;e.done?o(e.value):(t=e.value,t instanceof a?t:new a(function(e){e(t)})).then(l,s)}i((r=r.apply(e,t||[])).next())});var e,t,a,r})})();
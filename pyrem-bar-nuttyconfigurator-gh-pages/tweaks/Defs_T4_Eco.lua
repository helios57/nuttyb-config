-- T4_ECO_START
do

local unitDefs = UnitDefs or {}
local merge = table.merge
local factions = {'arm', 'cor', 'leg'}
local legendaryScale = 2.0
local fusionEnergyScale = 1.3

local function cloneIfMissing(baseName, newName, overrides)
  if unitDefs[baseName] and not unitDefs[newName] then
    unitDefs[newName] = merge(unitDefs[baseName], overrides)
  end
end

local function mergeIfPresent(name, overrides)
  if unitDefs[name] then
    unitDefs[name] = merge(unitDefs[name], overrides)
  end
end

local function scaled(value, multiplier)
  if value then
    return math.ceil(value * multiplier)
  end
  return nil
end

local function ensureBuildOption(builderName, optionName)
  local builder = unitDefs[builderName]
  local option = unitDefs[optionName]
  if not builder or not option then
    return
  end

  builder.buildoptions = builder.buildoptions or {}
  for i = 1, #builder.buildoptions do
    if builder.buildoptions[i] == optionName then
      return
    end
  end

  builder.buildoptions[#builder.buildoptions + 1] = optionName
end

for _, faction in ipairs(factions) do
  local isLegion = faction == 'leg'

  -- energy converters (Legendary variant)
  local converterBaseName = isLegion and 'legadveconvt3' or (faction .. 'mmkrt3')
  local converterBase = unitDefs[converterBaseName]

  if converterBase then
    local baseCustom = converterBase.customparams or {}
    local legendaryConverterName = converterBaseName .. '_200'

    cloneIfMissing(converterBaseName, legendaryConverterName, {
      description = 'Legendary Energy Converter by Jackie',
      metalcost = scaled(converterBase.metalcost, legendaryScale),
      energycost = scaled(converterBase.energycost, legendaryScale),
      buildtime = scaled(converterBase.buildtime, legendaryScale),
      health = scaled(converterBase.health, legendaryScale * 6),
      customparams = {
        energyconv_capacity = scaled(baseCustom.energyconv_capacity, 2),
        energyconv_efficiency = 0.022,
        buildinggrounddecaldecayspeed = baseCustom.buildinggrounddecaldecayspeed,
        buildinggrounddecalsizex = baseCustom.buildinggrounddecalsizex,
        buildinggrounddecalsizey = baseCustom.buildinggrounddecalsizey,
        buildinggrounddecaltype = baseCustom.buildinggrounddecaltype,
        model_author = baseCustom.model_author,
        normaltex = baseCustom.normaltex,
        removestop = baseCustom.removestop,
        removewait = baseCustom.removewait,
        subfolder = baseCustom.subfolder,
        techlevel = baseCustom.techlevel,
        unitgroup = baseCustom.unitgroup,
        usebuildinggrounddecal = baseCustom.usebuildinggrounddecal,
        i18n_en_humanname = 'Legendary Energy Converter',
        i18n_en_tooltip = 'Convert 12k energy to 264m/s by Jackie (Extremely Explosive)'
      },
      name = 'Legendary Energy Converter',
      buildpic = converterBase.buildpic,
      objectname = converterBase.objectname,
      footprintx = 6,
      footprintz = 6,
      yardmap = converterBase.yardmap,
      script = converterBase.script,
      activatewhenbuilt = converterBase.activatewhenbuilt,
      sightdistance = converterBase.sightdistance,
      seismicsignature = converterBase.seismicsignature,
      idleautoheal = converterBase.idleautoheal,
      idletime = converterBase.idletime,
      maxslope = converterBase.maxslope,
      maxwaterdepth = converterBase.maxwaterdepth,
      maxacc = converterBase.maxacc,
      maxdec = converterBase.maxdec,
      explodeas = "fusionExplosion",
      selfdestructas = "fusionExplosion",
      corpse = converterBase.corpse,
      canrepeat = converterBase.canrepeat

    })
  end

  -- fusion reactors (Legendary variant)
  local fusionBaseName = faction .. 'afust3'
  local fusionBase = unitDefs[fusionBaseName]

  if fusionBase then
    local baseCustom = fusionBase.customparams or {}
    local legendaryFusionName = fusionBaseName .. '_200'

    cloneIfMissing(fusionBaseName, legendaryFusionName, {
      buildtime = scaled(fusionBase.buildtime, 1.8),
      name = 'Legendary Fusion Reactor',
      description = 'Legendary Fusion Reactor by Jackie (Extremely Explosive)',
      metalcost = scaled(fusionBase.metalcost, legendaryScale),
      energycost = scaled(fusionBase.energycost, legendaryScale),
      energymake = scaled(fusionBase.energymake, 2.4),
      energystorage = scaled(fusionBase.energystorage, 6.0),
      health = scaled(fusionBase.health, legendaryScale * 3),
      buildpic = fusionBase.buildpic,
      collisionvolumeoffsets = fusionBase.collisionvolumeoffsets,
      collisionvolumescales = fusionBase.collisionvolumescales,
      collisionvolumetype = fusionBase.collisionvolumetype,
      damagemodifier = 0.95,
      buildangle = fusionBase.buildangle,
      objectname = fusionBase.objectname,
      footprintx = 12,
      footprintz = 12,
      yardmap = fusionBase.yardmap,
      script = fusionBase.script,
      activatewhenbuilt = fusionBase.activatewhenbuilt,
      sightdistance = fusionBase.sightdistance,
      seismicsignature = fusionBase.seismicsignature,
      idleautoheal = scaled(fusionBase.idleautoheal, 6),
      idletime = fusionBase.idletime,
      maxslope = fusionBase.maxslope,
      maxwaterdepth = fusionBase.maxwaterdepth,
      maxacc = fusionBase.maxacc,
      maxdec = fusionBase.maxdec,
      explodeas = "ScavComBossExplo",
      selfdestructas = "ScavComBossExplo",
      corpse = fusionBase.corpse,
      canrepeat = fusionBase.canrepeat,
      customparams = {

        buildinggrounddecaldecayspeed = 30,
        buildinggrounddecalsizex = 18,
        buildinggrounddecalsizey = 18,
        buildinggrounddecaltype = baseCustom.buildinggrounddecaltype,
        model_author = baseCustom.model_author,
        normaltex = baseCustom.normaltex,
        subfolder = baseCustom.subfolder,
        removestop = true,
        removewait = true,
        techlevel = 3,
        unitgroup = "energy",
        usebuildinggrounddecal = true,
        i18n_en_humanname = 'Legendary Fusion Reactor',
        i18n_en_tooltip = 'Convert 12k energy to 264m/s by Jackie (Extremely Explosive)'
      },
      sfxtypes = {
        pieceexplosiongenerators = {
          [1] = "deathceg2",
          [2] = "deathceg3",
          [3] = "deathceg4"
        }
      },
      sounds = {
        canceldestruct = "cancel2",
        underattack = "warning1",
        count = {"count6", "count5", "count4", "count3", "count2", "count1"},
        select = {"fusion2"}
      }
    })
  end

  -- T3 Aides pick up the new options if both builder and options exist
  local groundBuilderName = faction .. 't3aide'
  local airBuilderName = faction .. 't3airaide'

  local optionNames = {
    converterBaseName and (converterBaseName .. '_200') or nil,
    fusionBaseName and (fusionBaseName .. '_200') or nil
  }

  for _, optionName in ipairs(optionNames) do
    if optionName then
      ensureBuildOption(groundBuilderName, optionName)
      ensureBuildOption(airBuilderName, optionName)
    end
  end
end

local sharedBuilders = {'armack', 'armaca', 'armacv', 'corack', 'coraca', 'coracv', 'legack', 'legaca', 'legacv'}

for _, builderName in ipairs(sharedBuilders) do
  local builder = unitDefs[builderName]
  if builder then
    local factionPrefix = builderName:sub(1, 3)
    local converterBaseName = (factionPrefix == 'leg') and 'legadveconvt3' or (factionPrefix .. 'mmkrt3')

    ensureBuildOption(builderName, converterBaseName .. '_200')

    local fusionBaseName = factionPrefix .. 'afust3'
    ensureBuildOption(builderName, fusionBaseName .. '_200')
  end
end
end

-- T4_ECO_END

